<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Untitled Document</title>
    <script src="https://d3js.org/d3.v3.js"></script>
    <style>
        body{
            background: #eee;
        }
        .axis path, .axis line{
            fill: none;
            stroke: black;
            shape-rendering: auto;
        }
        .axis text {
            font-size: 8px;
        }
    </style>
</head>
<body>
    <script>
        // 1. 定義width, height, padding, letterList變數
        var w = 900;
        var h = 600;
        var padding = 90;
        var letterList = ["A","B","C","D","E","F","G","H","I","J","K","M","N","O","P","Q","T","U","V","W","X","Z"];
        
        //2. 建立svg()畫布環境
        
        svg();       
        
        //3. 用d3讀取csv
        d3.csv("invoice.csv", function(dataSet){
            
                        console.log(dataSet[0]);
           bind(dataSet);
           render(dataSet);
           btnList(dataSet);
        });
        
        
        function svg(){
           d3.select("body").append("svg").attr({
               width: w,
               height: h
           });
           // g means group
            d3.select("svg").append("g").append("rect").attr({
                width: "100%",
                height: "100%",
                fill: "white"
            });
        }
        
        //4. 建立bind()

        function bind(dataSet){
            var selection = d3.select("svg")
                                .selectAll("circle")
                                .data(dataSet);
            
            selection.enter().append("circle");
            selection.exit().remove();
        }
        
        function render(dataSet){
            
            //5. 定義xScale,yScale,rScale, fScale比例尺(range目的在決定在svg上位置)

            var xScale = d3.time.scale()
                     .domain([new Date("2013/01/01"), new Date("2016/08/01")])
                     .range([padding, w-padding]);
            var yScale = d3.scale.linear()
                     .domain([0, d3.max(dataSet, function(item){
                         return +item.number; 
                     })])
                     .range([h-padding, padding]);

            // radius
            var rScale = d3.scale.linear()
                     .domain([
                         d3.min(dataSet, function(item){
                             return +item.amount;
                         }),
                         d3.max(dataSet, function(item){
                             return +item.amount;
                         })
                     ])
                     .range([5, 30]);

            // colour
            var fScale = d3.scale.category20();
            
            console.log(xScale(new Date("2015/10/20")))
            
            //6. 建立render()繪圖
            d3.selectAll("circle")
               .attr({
                    cx: function(item) {
                        return xScale(new Date(item.date));
                    },
                    cy: function(item) {
                        return yScale(+item.number);
                    },
                    r: function(item) {
                        return rScale(+item.amount);
                    },
                    fill: function(item) {
                        return fScale(letterList.indexOf(item.cid));    
                    }
                });
            var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom");
            var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("right");
            d3.select("svg").append("g").attr("class", "axis").attr("transform", "translate(0, "+(h-padding+15)+")").call(xAxis); //把軸線印出來
            d3.select("svg").append("g").attr("class", "axis").attr("transform", "translate("+(10)+", 0)" ).call(yAxis); //把軸線印出來
        }
            
        function btnList(dataSet){
            var industryArr = dataSet.map(function(d){
                return d.industry;
            });
            var uniqueIndustry = unique(industryArr);
            //console.log("unique industry: ", uniqueIndustry);
            var selection = d3.select("body").selectAll("div").data(uniqueIndustry);
            selection.enter().append("div");
            selection.exit().remove();
        }
        
        function unique(array) {
            var n = []; 
  
            //去看每個array，如果沒出現過就加到n中      
            array.map(function(tile){
                if (n.indexOf(tile) === -1) {
                    n.push(tile);
                }
            });
            console.log("result: ", n)
            return n;
        }
        
    </script>

</body>
</html>