<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>D3_HW-04</title>
    <script src="//d3js.org/d3.v3.js"></script>
    <script src="script.js"></script>
    <link rel="stylesheet" href="default.css">
</head>
<body>
    <svg class="invoice-data" width="1000" height="250">
            
    </svg>
    <hr />
    
    <div class="scores" style="width: 1000; height: 100">
        <div></div>
    </div>
    <hr />
    
    <svg id = "svg2" class="invoice-vertical" width="1000" height="200">
            
    </svg>
    <input type=button value="新增" onclick="update();">
    <script>
        // part 1
        d3.json("invoice.json", function(dataSet) {
            var svg = d3.select(".invoice-data");
            var count = 0;
            let maxAmount = 1000000000;
            let ratio = 30 / maxAmount;
            for (var i=0; i< dataSet.length; i=i+1) {
                if (parseInt(dataSet[i].amount) > maxAmount && dataSet[i].cid === 'A' && dataSet[i].date === '2016/8/1' ) {
                    svg.append("text")
                       .attr({
                         x: 10,
                         y: 20 + count * 20
                       })
                       .text(`${dataSet[i].industry}`);
                    svg.append("rect")
                       .attr({
                         x: 300,
                         y: 5 + count * 20,
                         width : dataSet[i].amount * ratio,
                         height: 16,
                         fill: "red"
                       });
                    count = count + 1;
                    
                }
            }
        });
        
        // part 2
        var scores = [85, 60, 99, 49, 77, 82];
        bindScores(scores);
        renderScores();
        
        function bindScores(data) {
            var selection = d3 
                            .select(".scores")
                            .selectAll(".scores div")
                            .data(data);
            selection.enter().append("div");
            selection.exit().remove();
        }
        
        function renderScores() {
            d3
                .select(".scores")
                .selectAll(".scores div")
                .text(function(data, index) {
                      return index + ": " + data;
                      })
                .attr({
                    style: function(data) {
                        if (data > 70) {
                            return "color: black";
                        } else {
                            return "color: red";

                        }
                    }
                });
        }
        
        // part 3
        var arr = [45, 78, 96, 35, 88, 69];
        var w = 1000;
        var h = 200;
        var p = 30;
        
        bind(arr);
        render(h, p);
        bindLabel(arr);
        renderLabel(h, p);
        
        function update() {
            var newOne = getRandomInt(20, 100) 
            arr.push(newOne);
            console.log(arr);
            bind(arr);
            render(h, p);
            bindLabel(arr);
            renderLabel(h, p);
        }
        
        function bind(data) {
            var selection = d3
                                .select(".invoice-vertical")
                                .selectAll("rect")
                                .data(data);
            selection.enter().append("rect");//綁定
            selection.exit().remove();
        }
        
        function render(h, p) {
            d3
                .select(".invoice-vertical")
                .selectAll("rect")
                .attr({
                    x: function(data, index) {
                        return p+45*index
                    },
                    y: function(data) {
                        return h - p - data;
                    },
                    width: 40,
                    height: function(data) {
                        return data;
                    },
                    fill: function(data) {
                        if (data < 70) {
                            return "red";
                        } else {
                            return "lightgreen";
                        }
                    }
                });
            
        }
        
        function bindLabel(data) {
            var selection = d3
                                .select(".invoice-vertical")
                                .selectAll("text")
                                .data(data);
            selection.enter().append("text");//綁定
            selection.exit().remove();
        }
        
        function renderLabel(h, p) {
            var textPaddingX = 12;
            var textPaddingY = 20;
            
            d3
                .select(".invoice-vertical")
                .selectAll("text")
                .attr({
                    x: function(data, index) {
                        return p + 45 * index + textPaddingX;
                    },
                    y: function(data) {
                        return h - p + textPaddingY;
                    },
                    fill: "black"
                })
                .text(function(data){
                    return data;
                });
            
        }
    </script>
</body>
</html>